# FTP Challenge Fix - Anonymous Access & Flag Location

## Issues Found

1. **Anonymous FTP access is disabled** - vsftpd.conf has `anonymous_enable=NO`
2. **Challenge files not copied** - Dockerfile doesn't copy challenge files into container
3. **Flag location unknown** - Flag file not found in expected locations
4. **Wrong credentials** - Challenge uses `kali:kali` instead of anonymous access

## Root Cause

1. The Dockerfile doesn't include `COPY` commands to copy challenge files
2. The vsftpd.conf file generated by AI may not have `anonymous_enable=YES`
3. The startup script doesn't properly configure vsftpd or place the flag

## Manual Fix (Current Challenge)

### Step 1: Fix vsftpd Configuration

```powershell
docker exec ctf-operation-silent-transfer-ftp-server sh -c "cat > /etc/vsftpd.conf << 'EOF'
listen=YES
listen_ipv6=NO
anonymous_enable=YES
anon_upload_enable=NO
anon_mkdir_write_enable=NO
anon_root=/var/ftp
no_anon_password=YES
write_enable=YES
local_enable=YES
chroot_local_user=YES
allow_writeable_chroot=YES
secure_chroot_dir=/var/run/vsftpd/empty
pam_service_name=vsftpd
pasv_enable=YES
pasv_min_port=21100
pasv_max_port=21110
userlist_enable=NO
dirmessage_enable=YES
use_localtime=YES
xferlog_enable=YES
connect_from_port_20=YES
EOF
"
```

### Step 2: Place Flag File

```powershell
# Get the flag from metadata (if available) or use a default
docker exec ctf-operation-silent-transfer-ftp-server sh -c "echo 'CTF{ftp_anonymous_access_exploit_2024}' > /var/ftp/data/classified/flag.txt && chmod 644 /var/ftp/data/classified/flag.txt && chown ftp:ftp /var/ftp/data/classified/flag.txt"
```

### Step 3: Restart vsftpd

```powershell
docker exec ctf-operation-silent-transfer-ftp-server pkill vsftpd
Start-Sleep -Seconds 1
docker exec -d ctf-operation-silent-transfer-ftp-server /usr/sbin/vsftpd /etc/vsftpd.conf
```

### Step 4: Test Anonymous Access

```powershell
# Test from attacker machine
docker exec ctf-operation-silent-transfer-attacker sh -c "echo -e 'user anonymous\npass\nls\ncd data\nls\ncd classified\nls\nget flag.txt\nquit' | ftp -n 172.23.195.12"
```

## Automation Fix

### 1. Dockerfile COPY Command

Added `COPY . /challenge/` to copy challenge files into container.

### 2. Startup Script Requirements

The startup script must:
- Copy vsftpd.conf from /challenge/ to /etc/vsftpd.conf
- Ensure `anonymous_enable=YES` in the config
- Place flag file in accessible location (e.g., /var/ftp/data/classified/)
- Start vsftpd service

### 3. AI Content Generation

The AI must generate:
- `vsftpd.conf` with `anonymous_enable=YES`
- Flag file in appropriate location
- Setup commands that copy config and place flag

## Expected Flag Location

For FTP challenges with anonymous access:
- **Location**: `/var/ftp/data/classified/flag.txt` or similar
- **Permissions**: Readable by anonymous user (644, owned by ftp:ftp)
- **Access Path**: Anonymous FTP → `/data/classified/` → `flag.txt`

## Verification

After fix, verify:
1. Anonymous login works: `ftp 172.23.195.12` → `anonymous` → (empty password)
2. Can navigate to `/data/classified/`
3. Can download `flag.txt`
4. Flag content matches expected format: `CTF{...}`


