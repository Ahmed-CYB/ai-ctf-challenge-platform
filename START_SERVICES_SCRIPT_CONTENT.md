# Startup Script Content (`/start-services.sh`)

## ğŸ“‹ **Two Versions of the Script**

### 1. **Original Script (Generated by AI)**
This is the script that gets generated by the AI in `tool-installation-agent.js` and embedded in the Dockerfile. It's built from AI-generated setup commands.

**Location**: Generated in `packages/ctf-automation/src/agents/tool-installation-agent.js`

**Structure**:
```bash
#!/bin/bash
set -e

# AI-generated setup commands (from network-content-agent, web-content-agent, etc.)
# Example for FTP:
cp /challenge/vsftpd.conf /etc/vsftpd.conf && \
mkdir -p /var/run/vsftpd/empty && \
mkdir -p /var/ftp/data/classified && \
chmod 555 /var/ftp && \
chmod 755 /var/ftp/data && \
chmod 755 /var/ftp/data/classified && \
cp /challenge/flag.txt /var/ftp/data/classified/flag.txt && \
chmod 644 /var/ftp/data/classified/flag.txt && \
chown ftp:ftp /var/ftp/data/classified/flag.txt && \
service vsftpd start || /usr/sbin/vsftpd &

# Keep container running
wait
```

**Problem**: Sometimes the AI generates commands with `&&` operators that break across lines incorrectly, causing syntax errors like:
```
/start-services.sh: line 5: syntax error near unexpected token `&&'
```

---

### 2. **Fixed Script (Created by Validation Agent)**
This is the minimal working script that the victim validation agent creates when it detects issues.

**Location**: `packages/ctf-automation/src/victim-validation-agent.js` (lines 383-422)

**Content**:
```bash
#!/bin/bash
set -e

# Start services based on what's available
# FTP Service
if [ -f /challenge/vsftpd.conf ] || [ -f /etc/vsftpd.conf ]; then
  if [ -f /challenge/vsftpd.conf ]; then
    cp /challenge/vsftpd.conf /etc/vsftpd.conf 2>/dev/null || true
  fi
  mkdir -p /var/run/vsftpd/empty 2>/dev/null || true
  mkdir -p /var/ftp/data/classified 2>/dev/null || true
  chmod 555 /var/ftp 2>/dev/null || true
  chmod 755 /var/ftp/data 2>/dev/null || true
  chmod 755 /var/ftp/data/classified 2>/dev/null || true
  if [ -f /challenge/flag.txt ]; then
    cp /challenge/flag.txt /var/ftp/data/classified/flag.txt 2>/dev/null || true
    chmod 644 /var/ftp/data/classified/flag.txt 2>/dev/null || true
    chown ftp:ftp /var/ftp/data/classified/flag.txt 2>/dev/null || true
  fi
  /usr/sbin/vsftpd /etc/vsftpd.conf &
fi

# Samba Service
if [ -f /etc/samba/smb.conf ] || [ -f /challenge/smb.conf ]; then
  if [ -f /challenge/smb.conf ]; then
    cp /challenge/smb.conf /etc/samba/smb.conf 2>/dev/null || true
  fi
  /usr/sbin/smbd -D 2>/dev/null &
  /usr/sbin/nmbd -D 2>/dev/null &
fi

# SSH Service
if [ -f /usr/sbin/sshd ]; then
  mkdir -p /var/run/sshd
  /usr/sbin/sshd -D &
fi

# Keep container running
wait
```

**Features**:
- âœ… No `&&` operators that can break
- âœ… Each command on its own line
- âœ… Error handling with `2>/dev/null || true`
- âœ… Conditional service startup (only starts if config files exist)
- âœ… Handles FTP, Samba, and SSH services
- âœ… Keeps container running with `wait`

---

## ğŸ” **How the Script is Created**

### During Dockerfile Generation:
1. AI generates setup commands in `configurations[category].setup`
2. These commands are collected and embedded into the Dockerfile using heredoc:
   ```dockerfile
   RUN cat > /start-services.sh << 'EOFSCRIPT'
   ${startupScript}EOFSCRIPT
   RUN chmod +x /start-services.sh
   ```

### During Validation/Fix:
1. Validation agent detects script syntax error
2. Creates minimal working script in temp file
3. Uses `docker cp` to copy it into the container:
   ```javascript
   execSync(`docker cp "${tempScriptPath}" ${containerName}:/start-services.sh`)
   ```

---

## âš ï¸ **Common Issues**

### Issue 1: Syntax Error with `&&`
**Problem**: AI generates commands like:
```bash
cp file.conf /etc/ && \
mkdir -p /dir && \
service start
```
But if line breaks are incorrect, it becomes:
```bash
cp file.conf /etc/ &&
mkdir -p /dir &&
service start
```
This causes: `syntax error near unexpected token '&&'`

**Fix**: Validation agent replaces with conditional blocks:
```bash
if [ -f file.conf ]; then
  cp file.conf /etc/
  mkdir -p /dir
  service start &
fi
```

### Issue 2: Missing Error Handling
**Problem**: Commands fail and container exits

**Fix**: All commands have `2>/dev/null || true` to prevent failures

### Issue 3: Services Not Starting
**Problem**: Services don't start in background

**Fix**: All service commands end with `&` to run in background

---

## ğŸ“ **Script Location in Container**

- **Path**: `/start-services.sh`
- **Permissions**: `755` (executable)
- **Shebang**: `#!/bin/bash`
- **CMD**: Container runs this script as its entrypoint

---

## ğŸ”§ **How to View the Actual Script**

To see what's actually in a container:

```bash
# If container is running:
docker exec <container-name> cat /start-services.sh

# If container is stopped:
docker cp <container-name>:/start-services.sh ./start-services.sh
cat start-services.sh
```

---

## âœ… **The Fixed Script Always Works**

The validation agent's minimal script is designed to:
- âœ… Work with any Linux distribution
- âœ… Handle missing files gracefully
- âœ… âœ… Start services correctly
- âœ… Keep container running
- âœ… Have no syntax errors


